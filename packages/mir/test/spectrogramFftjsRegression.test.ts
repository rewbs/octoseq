import { describe, expect, it } from "vitest";

/* eslint-disable @typescript-eslint/no-loss-of-precision */
/* eslint-disable no-loss-of-precision */

import { spectrogram } from "../src/dsp/spectrogram";

// Baseline fixture captured from the previous (hand-rolled radix-2) FFT implementation.
// We only store a small slice (first frames/bins) to keep the fixture stable and reviewable.
//
// Numerical tolerance:
// - We compare magnitudes with absolute tolerance 1e-2.
// - This is intentionally loose enough to allow small implementation differences (twiddle
//   recurrence vs library FFT) while still catching gross regressions.
const BASELINE = {
    sampleRate: 48000,
    fftSize: 1024,
    hopSize: 256,
    window: "hann" as const,
    times: [
        0.01066666655242443,
        0.01600000075995922,
        0.02133333310484886,
        0.02666666731238365
    ],
    magnitudes: [
        [
            11.947715759277344, 24.12233543395996, 18.272546768188477,
            1.6718864440917969, 0.16975180804729462, 0.48176655173301697,
            1.2548339366912842, 4.072737216949463, 35.80482864379883,
            139.35011291503906, 119.77460479736328, 17.716079711914062,
            3.0007801055908203, 1.0425723791122437, 0.4778478145599365,
            0.25238221883773804, 0.14233289659023285, 0.07911824434995651,
            0.035934239625930786, 0.008065042085945606, 0.04731279984116554,
            0.1147506907582283, 0.2502234876155853, 0.6061404347419739,
            2.021164894104004, 20.791099548339844, 71.70836639404297,
            56.73472595214844, 6.908531188964844, 1.2728221416473389,
            0.45878517627716064, 0.21812690794467926, 0.12140635401010513,
            0.07489895820617676, 0.04969972372055054, 0.03481733798980713,
            0.025438440963625908, 0.019217511638998985, 0.014917304739356041,
            0.01184336468577385, 0.009580849669873714, 0.007876796647906303,
            0.006565437652170658, 0.0055389669723808765,
            0.004722255747765303, 0.00406237319111824, 0.0035250745713710785,
            0.003079768270254135, 0.002708935644477606, 0.002397154690697789,
            0.0021326716523617506, 0.0019068908877670765,
            0.0017127294559031725, 0.0015436242101714015,
            0.0013984953984618187, 0.0012721489183604717,
            0.0011577230179682374, 0.0010584878036752343,
            0.0009690978331491351, 0.0008921726257540286,
            0.0008221603347919881, 0.0007593040936626494,
            0.0007032726425677538
        ],
        [
            3.7915267944335938, 24.880645751953125, 18.004980087280273,
            1.8056879043579102, 0.19938203692436218, 0.4250405728816986,
            1.2114819288253784, 4.038917541503906, 35.77748489379883,
            139.37298583984375, 119.75481414794922, 17.733802795410156,
            3.017275810241699, 1.0586199760437012, 0.49428772926330566,
            0.27029678225517273, 0.16338804364204407, 0.1063690260052681,
            0.07589943706989288, 0.06695937365293503, 0.08441843837499619,
            0.1388620287179947, 0.2674000561237335, 0.6191915273666382,
            2.0315005779266357, 20.799503326416016, 71.70140838623047,
            56.74055480957031, 6.903614521026611, 1.2686463594436646,
            0.4552237093448639, 0.21507710218429565, 0.11878710985183716,
            0.07264658063650131, 0.047756098210811615, 0.03313985466957092,
            0.023987235501408577, 0.017961813136935234,
            0.013829243369400501, 0.010899439454078674,
            0.008762606419622898, 0.007166354451328516,
            0.00594893004745245, 0.005004155449569225,
            0.0042572966776788235, 0.0036595051642507315,
            0.003175661200657487, 0.0027779070660471916,
            0.0024481036234647036, 0.0021728845313191414,
            0.001939053530804813, 0.0017407010309398174,
            0.0015707071870565414, 0.001423264155164361,
            0.0012970654061064124, 0.0011829453287646174,
            0.0010859391186386347, 0.0009992901468649507,
            0.000922385894227773, 0.0008544233860448003,
            0.0007923850789666176, 0.0007372025866061449,
            0.000688087719026953
        ],
        [
            15.166298866271973, 23.642427444458008, 18.393898010253906,
            1.6350876092910767, 0.17251640558242798, 0.4803439676761627,
            1.2475210428237915, 4.062753677368164, 35.79339599609375,
            139.36264038085938, 119.76090240478516, 17.731311798095703,
            3.018109083175659, 1.062836766242981, 0.5022560358047485,
            0.2827233374118805, 0.1813451051712036, 0.13118554651737213,
            0.10833270847797394, 0.10476920753717422, 0.12155882269144058,
            0.17100374400615692, 0.2938123643398285, 0.6406131386756897,
            2.0489087104797363, 20.813758850097656, 71.68962097167969,
            56.750396728515625, 6.8953022956848145, 1.2615585327148438,
            0.44912487268447876, 0.2097826451063156, 0.11415442824363708,
            0.068563312292099, 0.044132839888334274, 0.029907098039984703,
            0.0210860688239336, 0.015345664694905281,
            0.011460568755865097, 0.008745347149670124,
            0.006798556540161371, 0.005368510726839304,
            0.004298779182136059, 0.0034861722961068153,
            0.0028587866108864546, 0.002367612672969699,
            0.001979721011593938, 0.0016690978081896901,
            0.0014183701714500785, 0.0012151937698945403,
            0.001047869329340756, 0.0009114540298469365,
            0.0007957681082189083, 0.0007005451479926705,
            0.0006211213185451925, 0.0005530005437321961,
            0.0004942879895679653, 0.000444758974481374,
            0.00040185495163314044, 0.00036570889642462134,
            0.0003343286516610533, 0.0003069087688345462,
            0.00028292706701904535
        ],
        [
            9.142875671386719, 24.47194480895996, 18.14176368713379,
            1.7731250524520874, 0.32565104961395264, 0.5257387161254883,
            1.2712186574935913, 4.079737663269043, 35.807029724121094,
            139.35107421875, 119.77114868164062, 17.721891403198242,
            3.009087324142456, 1.0538169145584106, 0.49282601475715637,
            0.27242758870124817, 0.16969628632068634, 0.11776520311832428,
            0.09311043471097946, 0.08854074776172638, 0.10581754148006439,
            0.15697140991687775, 0.28190022706985474, 0.6306937336921692,
            2.040663957595825, 20.806865692138672, 71.6954345703125,
            56.745445251464844, 6.899568557739258, 1.2652662992477417,
            0.452372670173645, 0.21265052258968353, 0.11670275777578354,
            0.07084193080663681, 0.04618049040436745, 0.03175462782382965,
            0.022760508581995964, 0.01686837151646614,
            0.012848439626395702, 0.010015018284320831,
            0.007961522787809372, 0.006437624339014292,
            0.005283411126583815, 0.004390919581055641,
            0.0036934292875230312, 0.0031392346136271954,
            0.0026911734603345394, 0.0023286554496735334,
            0.002028997056186199, 0.0017802395159378648,
            0.0015725998673588037, 0.0013970239087939262,
            0.0012467170599848032, 0.001119700726121664,
            0.0010082972003147006, 0.000913711846806109,
            0.0008295727311633527, 0.0007558976649306715,
            0.0006927541689947248, 0.000634808384347707,
            0.0005845953710377216, 0.0005397014901973307,
            0.000499312300235033
        ]
    ]
};

function makeTestAudio(): {
    sampleRate: number;
    numberOfChannels: number;
    getChannelData: (ch: number) => Float32Array;
} {
    const sampleRate = BASELINE.sampleRate;
    const fftSize = BASELINE.fftSize;
    const hopSize = BASELINE.hopSize;
    const length = fftSize + hopSize * 6; // 7 frames

    const mono = new Float32Array(length);
    for (let i = 0; i < length; i++) {
        // Deterministic mixture
        mono[i] =
            0.6 * Math.sin((2 * Math.PI * 440 * i) / sampleRate) +
            0.3 * Math.sin((2 * Math.PI * 1234 * i) / sampleRate) +
            0.1 * Math.sin((2 * Math.PI * 60 * i) / sampleRate);
    }

    return {
        sampleRate,
        numberOfChannels: 1,
        getChannelData: () => mono
    };
}

describe("@octoseq/mir spectrogram regression (fft.js FFT swap)", () => {
    it("shape: frame count, bin count, and times", async () => {
        const audio = makeTestAudio();
        const spec = await spectrogram(audio, {
            fftSize: BASELINE.fftSize,
            hopSize: BASELINE.hopSize,
            window: BASELINE.window
        });

        // frames: length = fftSize + hopSize*6 => nFrames = 1 + floor((len - fftSize)/hop)
        expect(spec.magnitudes.length).toBe(7);
        expect(spec.times.length).toBe(7);

        // bins = N/2 + 1
        expect(spec.magnitudes[0]?.length).toBe(BASELINE.fftSize / 2 + 1);

        // Times are centered in each frame.
        for (let i = 0; i < BASELINE.times.length; i++) {
            expect(spec.times[i]).toBeCloseTo(BASELINE.times[i] ?? 0, 7);
        }
    });

    it("matches baseline magnitudes within tolerance (first frames/bins)", async () => {
        const audio = makeTestAudio();
        const spec = await spectrogram(audio, {
            fftSize: BASELINE.fftSize,
            hopSize: BASELINE.hopSize,
            window: BASELINE.window
        });

        const absTol = 1e-2;

        for (let frame = 0; frame < BASELINE.magnitudes.length; frame++) {
            const got = spec.magnitudes[frame];
            const exp = BASELINE.magnitudes[frame] ?? [];
            expect(got).toBeTruthy();

            for (let bin = 0; bin < exp.length; bin++) {
                const gv = got?.[bin] ?? 0;
                const ev = exp[bin] ?? 0;
                expect(Number.isFinite(gv)).toBe(true);
                expect(Math.abs(gv - ev)).toBeLessThanOrEqual(absTol);
            }
        }
    });

    it("silence produces zeros (no NaNs)", async () => {
        const sampleRate = 48000;
        const fftSize = 1024;
        const hopSize = 256;
        const length = fftSize + hopSize * 2;

        const mono = new Float32Array(length);
        const audio = {
            sampleRate,
            numberOfChannels: 1,
            getChannelData: () => mono
        };

        const spec = await spectrogram(audio, { fftSize, hopSize, window: "hann" });
        expect(spec.magnitudes.length).toBe(3);

        for (const row of spec.magnitudes) {
            for (const v of row) {
                expect(Number.isFinite(v)).toBe(true);
                expect(v).toBe(0);
            }
        }
    });
});
